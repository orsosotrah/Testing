#!/bin/bash

set -e

# Logging
echo "Running GPT analysis..."

# Baca isi log
LOG_FILE_PATH=".github/workflows/gpt_output.txt"
if [ ! -f "$LOG_FILE_PATH" ]; then
  echo "Log file not found: $LOG_FILE_PATH"
  exit 1
fi
LOG=$(cat "$LOG_FILE_PATH")

# Prompt utama
CONTENT="You are an AI DevOps assistant. You help analyze CI/CD logs from GitHub Actions and explain errors clearly. Suggest what might have gone wrong and how to fix it."

# Buat thread
THREAD_RESPONSE=$(curl -s -X POST https://api.openai.com/v1/threads \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "OpenAI-Beta: assistants=v2" \
  -H "Content-Type: application/json")
THREAD_ID=$(echo "$THREAD_RESPONSE" | jq -r .id)

# Kirim pesan
MESSAGE_PAYLOAD=$(jq -n --arg content "$CONTENT" --arg log "$LOG" \
  '{"messages": [{"role": "user", "content": ($content + "\n\n" + $log)}]}')

curl -s -X POST https://api.openai.com/v1/threads/$THREAD_ID/messages \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "OpenAI-Beta: assistants=v2" \
  -H "Content-Type: application/json" \
  -d "$MESSAGE_PAYLOAD"

# Jalankan assistant
RUN_RESPONSE=$(curl -s -X POST https://api.openai.com/v1/threads/$THREAD_ID/runs \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "OpenAI-Beta: assistants=v2" \
  -H "Content-Type: application/json" \
  -d "{\"assistant_id\": \"$ASSISTANT_ID\"}")
RUN_ID=$(echo "$RUN_RESPONSE" | jq -r .id)

# Tunggu sampai selesai
STATUS="queued"
while [[ "$STATUS" != "completed" && "$STATUS" != "failed" ]]; do
  sleep 5
  STATUS_RESPONSE=$(curl -s -X GET https://api.openai.com/v1/threads/$THREAD_ID/runs/$RUN_ID \
    -H "Authorization: Bearer $OPENAI_API_KEY" \
    -H "OpenAI-Beta: assistants=v2")
  STATUS=$(echo "$STATUS_RESPONSE" | jq -r .status)
done

# Ambil hasil
curl -s -X GET https://api.openai.com/v1/threads/$THREAD_ID/messages \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "OpenAI-Beta: assistants=v2" | jq -r '.data[0].content[0].text.value'
