# .github/workflows/ci.yml
name: build-and-test
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v3
      
      # Create logs directory at the beginning of the workflow
      - name: Create logs directory
        run: mkdir -p logs
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore
      - name: Test
        run: |
          # Run tests and capture output
          dotnet test --no-build --verbosity normal | tee logs/test_output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          # Add explicit information about test failures
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "Tests failed with exit code $TEST_EXIT_CODE" | tee -a logs/test_output.log
            exit $TEST_EXIT_CODE
          fi
      
      - name: Analyze failure with Claude
        if: failure()
        run: |
          # Ensure logs directory exists again (in case the job was restarted)
          mkdir -p logs
          
          echo "Running Claude analysis..."
          # Create input file with basic information
          echo "### CI Logs" > logs/claude_input.txt
          echo "Build failed in GitHub Actions" >> logs/claude_input.txt
          
          # Check if test_output.log exists and has content
          if [ -f logs/test_output.log ] && [ -s logs/test_output.log ]; then
            echo "Found test_output.log, adding content to analysis" | tee -a logs/claude_input.txt
            echo "--- Test Output Log Content ---" >> logs/claude_input.txt
            tail -n 1000 logs/test_output.log >> logs/claude_input.txt
          else
            echo "Error: test_output.log file not found or empty" | tee -a logs/claude_input.txt
            # Try to find any useful information from the workflow
            echo "--- Attempting to gather build information ---" >> logs/claude_input.txt
            find . -name "*.binlog" -o -name "*.log" | xargs ls -la >> logs/claude_input.txt 2>/dev/null || echo "No log files found"
            echo "Current directory content:" >> logs/claude_input.txt
            ls -la >> logs/claude_input.txt
            ls -la logs >> logs/claude_input.txt 2>/dev/null || echo "logs directory not found"
          fi
          
          # Construct the prompt
          SYSTEM_PROMPT="You are an AI DevOps assistant. You help analyze CI/CD logs from GitHub Actions and explain errors clearly. Suggest what might have gone wrong and how to fix it."
          USER_PROMPT=$(cat logs/claude_input.txt)
          
          # Make API call to Claude
          CLAUDE_RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-3-haiku-20240307",
              "max_tokens": 1000,
              "system": "'$SYSTEM_PROMPT'",
              "messages": [
                {
                  "role": "user",
                  "content": '"$(echo "$USER_PROMPT" | jq -Rs .)"'
                }
              ]
            }')
          
          if [ -z "$CLAUDE_RESPONSE" ]; then
            echo "Error: Empty response from Claude API"
            exit 1
          fi
          
          # Extract the analysis from the response
          ANALYSIS=$(echo $CLAUDE_RESPONSE | jq -r '.content[0].text')
          
          if [ -z "$ANALYSIS" ] || [ "$ANALYSIS" = "null" ]; then
            echo "Error: Failed to extract analysis from response"
            echo "Response: $CLAUDE_RESPONSE"
            exit 1
          fi
          
          echo "Claude Analysis:"
          echo "$ANALYSIS"
          echo "$ANALYSIS" > logs/claude_analysis.txt
      
      - name: Upload artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: claude-analysis
          path: logs/
          if-no-files-found: warn
