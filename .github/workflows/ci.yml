name: Dynamic CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore -v d > build.log 2>&1 || (cat build.log && exit 1)
      - name: Test
        run: dotnet test --no-build --verbosity normal --logger "trx" || true

      - name: Create error log file
        if: failure()
        run: |
          mkdir -p logs
          echo "## Build Failure Log" > error_log.txt
          echo "Error occurred during the build process." >> error_log.txt
          echo '```' >> error_log.txt
          
          # Capture more comprehensive error information
          echo "## Build Log" >> error_log.txt
          cat build.log 2>/dev/null >> error_log.txt || echo "No build.log available"
          
          # Capture test results if available
          echo "## Test Results" >> error_log.txt
          find . -name "*.trx" -exec cat {} \; 2>/dev/null >> error_log.txt || echo "No test results available"
          
          # Include GitHub step summary if available
          echo "## GitHub Step Summary" >> error_log.txt
          cat $GITHUB_STEP_SUMMARY 2>/dev/null >> error_log.txt || echo "No step summary available"
          
          # Include environment information
          echo "## Environment Information" >> error_log.txt
          dotnet --info >> error_log.txt
          
          echo '```' >> error_log.txt

      - name: Analyze failure with Claude
        if: failure() && env.ANTHROPIC_API_KEY != ''
        run: |
          ERROR_CONTENT=$(cat error_log.txt)
          
          # Save JSON to file to avoid escaping issues
          cat > request.json << 'EOF'
          {
            "model": "claude-3-haiku-20240307",
            "max_tokens": 1000,
            "system": "Kamu adalah asisten AI DevOps. Analisis log CI/CD dan jelaskan kesalahan dengan jelas. Tampilkan ulang pesan kesalahannya.",
            "messages": [
              {
                "role": "user",
                "content": 
          EOF
          
          # Append error content to JSON file - use jq for proper escaping
          echo "$ERROR_CONTENT" | jq -Rs '.' >> request.json
          
          # Close the JSON structure
          cat >> request.json << 'EOF'
              }
            ]
          }
          EOF
          
          # Call Claude API
          CLAUDE_RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @request.json)
          
          # Extract response text
          echo "Claude Analysis:"
          echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text // "Analysis not available"'
          
          # Save the analysis to a file for review
          echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text // "Analysis not available"' > claude_analysis.txt
      
      - name: Analyze failure with ChatGPT
        if: failure() && env.OPENAI_API_KEY != '' 
        run: |
          ERROR_CONTENT=$(cat error_log.txt)
          
          # Save JSON to file to avoid escaping issues
          cat > request.json << 'EOF'
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "Kamu adalah asisten AI DevOps. Analisis log CI/CD dan jelaskan kesalahan dengan jelas. Tampilkan ulang pesan kesalahannya."
              },
              {
                "role": "user",
                "content": 
          EOF
          
          # Append error content to JSON file - use jq for proper escaping
          echo "$ERROR_CONTENT" | jq -Rs '.' >> request.json
          
          # Close the JSON structure
          cat >> request.json << 'EOF'
              }
            ],
            "max_tokens": 1000,
            "temperature": 0
          }
          EOF
          
          # Call OpenAI API
          CHATGPT_RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json)
          
          # Extract response text
          echo "ChatGPT Analysis:"
          echo "$CHATGPT_RESPONSE" | jq -r '.choices[0].message.content // "Analysis not available"'
          
          # Save the analysis to a file for review
          echo "$CHATGPT_RESPONSE" | jq -r '.choices[0].message.content // "Analysis not available"' > chatgpt_analysis.txt
      
      - name: Upload error logs as artifacts
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: error-logs
          path: |
            error_log.txt
            claude_analysis.txt
            chatgpt_analysis.txt
            build.log
            **/*.trx
