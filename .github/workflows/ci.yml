name: Dynamic CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore
      - name: Test
        run: dotnet test --no-build --verbosity normal

      - name: Create error log file
        if: failure()
        run: |
          echo "## Build Failure Log" > error_log.txt
          echo "Error occurred during the build process." >> error_log.txt
          echo '```' >> error_log.txt
          cat $GITHUB_STEP_SUMMARY 2>/dev/null >> error_log.txt
          echo '```' >> error_log.txt

      - name: Analyze failure with Claude
        if: failure() && env.ANTHROPIC_API_KEY != ''
        run: |
          ERROR_CONTENT=$(cat error_log.txt)
          
          # Save JSON to file to avoid escaping issues
          cat > request.json << EOF
          {
            "model": "claude-3-haiku-20240307",
            "prompt": "\n\nHuman: You are an AI DevOps assistant. Analyze CI/CD logs and explain errors clearly.\n\n$ERROR_CONTENT\n\nAssistant: ",
            "max_tokens_to_sample": 1000,
            "temperature": 0
          }
          EOF
          
          # Call Claude API using completions endpoint
          CLAUDE_RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/complete \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @request.json)
          
          # Extract response text
          echo "Claude Analysis:"
          echo "$CLAUDE_RESPONSE" | jq -r '.completion // "Analysis not available"'
      
      - name: Analyze failure with ChatGPT
        if: failure() && env.OPENAI_API_KEY != '' 
        run: |
          ERROR_CONTENT=$(cat error_log.txt)
          
          # Save JSON to file to avoid escaping issues
          cat > request.json << EOF
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "You are an AI DevOps assistant. Analyze CI/CD logs and explain errors clearly."
              },
              {
                "role": "user",
                "content": "$ERROR_CONTENT"
              }
            ],
            "max_tokens": 1000,
            "temperature": 0
          }
          EOF
          
          # Call OpenAI API
          CHATGPT_RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json)
          
          # Extract response text
          echo "ChatGPT Analysis:"
          echo "$CHATGPT_RESPONSE" | jq -r '.choices[0].message.content // "Analysis not available"'
